sudo: required
language: clojure
jdk:
  - openjdk11
services:
  - docker

cache:
  directories:
  - $HOME/.m2

env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "tRvqPsqprNHFdr+serQLOhgZz/QbsV1b4d2Jq556rG00YAeBsbIrZ/OR1hpQCcwUHcOmrVBjWXVaSTg1LdvE34r0Pad+hGKl8MxBkMIwSXWM/va61xqYY6nuLGB09qv6ZnG6hiNpxIYP2KNm6JwTH8FblKkq10HbA9ez5WZUwujhfMSEvCn0bG+u67xLbyOInbcRJPAk5oM/oDBNwGfKX34Oy4mANtbnlJon5y83o9foWoUvUDgD0TEqh6wnfeIcdaTTIb3OoZ28pkBAUXiU14qI2uj9oltCOMhp54+DWutLiVXM0+WzOGTcmRC0wyLYzgCalw1g6CeskAzXj0vulkTIknro6OnsudpdvPBNxc87fSENkFI94o/DTbtU75RHXY+Dw3/vtteGvrzmYeWU1WMqObV0Ddzz7T+4BPyHCRn5PMo8/yNgGQGE3kDmqJ3mESPeSBbeWnj1rdPudwrDhzmCJ4LL/6FPCUO+b9/H5H5tj39ydrNnomPHJUhq1pqY+RkmPWhEkY2dvPhJQnGzKqleKNd0qR5wkQrMIzgbRYO5ICM9h9/8rBhxGDeBV5frAh1dWvmBanEM5U6SWsyJl33f3P9vqHj1oE48E8NDp8voI3E+/V9fiDKjklAqUVzeNUa/O9QlW5Kd2pLO/BAYK8Lty1E/uVy1cKCRL0DFLmo="
    # AWS_SECRET_ACCESS_KEY
    - secure: "iAjYFxzOrLXjSsuvCksJvG77M0+oybP1Ul7d0zlshP80jtn2YGY8xue8ZWzjayLrV5nV2IE2lREJl8Of0fhRJPiD5JG1rNhOLD61GyMhqATue23NKbgWzZ7pj6Thy+q7JwAKXbAslterelCxCuz6gjhP2GCJcX+JI8oiyhH3Ysf18w1evgcJ65Ler+yh2llmVAFTuR68dL0QnsFjSXYa0o/wayqtgOwxBUe5kwZJNKJy0T9RU7EKawufYpEuc+CKo1QMMwA1jUYB4k1cv4jHvsmDlxXEeAJXe4dzW27L6U7OVclKk+2jmft5gjjZdfH2PfbGPZ+PIJxDRIwmwfOAkWjnFuThIS1mu3q5fauntX8TzFvAKvxGVj9A34bEsgv8+DmLjz4MMiIkyUTV65a/Y/aNUbxBmgAjaUISFkb/YykISj189n5QNgKiMBkWYCZUsqITeb8uriXR+hqh4VIkHoqhE+jKN+rGc6vWnmHBSOZb2Jrvqgbe9tfrM/i+UD97BVZmLJKfNCD7LruFgE4+J1fjU0q9iI85ZxN/Z1xgatWU5xSKNM4AvqeW809yRzKDMZBT0DQnMkHZ+lIwD6BHDNeozWSvnXQ4f8ZlKNmzx+JvsTMS/Ip/mIq4TXtLfeceDX34LTwoZKoWXbsUdr/wl5zhv5g7PmFgVYzntv/Mado="

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh

script:
  - lein -U test
  - lein uberjar

  - cp target/uberjar/konfo-backend-*-standalone.jar $DOCKER_BUILD_DIR/artifact/konfo-backend.jar
  - cp -vr oph-configuration $DOCKER_BUILD_DIR/config/

  - export BASE_IMAGE="baseimage-fatjar-openjdk11:master"
  - ./ci-tools/common/pull-image.sh
  - ./ci-tools/build/build-fatjar.sh konfo-backend
  - ./ci-tools/common/clean-docker-build-dir.sh
  - cp target/uberjar/konfo-backend-*-standalone.jar $DOCKER_BUILD_DIR/artifact/konfo-backend-updater.jar
  - cp -vr oph-configuration $DOCKER_BUILD_DIR/config/
  - ./ci-tools/build/build-fatjar.sh konfo-backend-updater

deploy:
  provider: script
  script: >-
    ./ci-tools/build/upload-image.sh konfo-backend &&
    ./ci-tools/build/upload-image.sh konfo-backend-updater
  on:
    all_branches: true



